#!/bin/bash

# Show actions for a specific VM
# This is called when a VM is selected from the VM modi

vm_name="$1"

echo "$(date): rofi-vm-actions called with: '$vm_name'" >> /tmp/rofi-vm-debug.log

if [ -z "$vm_name" ]; then
    echo "$(date): rofi-vm-actions: VM name is empty, exiting" >> /tmp/rofi-vm-debug.log
    exit 1
fi

# Get VM status
get_vm_status() {
    local vm_name="$1"
    local status=""
    
    status=$(virsh -c qemu:///system dominfo "$vm_name" 2>/dev/null | grep "State:" | awk '{print $2}')
    if [ -z "$status" ]; then
        status=$(virsh -c qemu:///session dominfo "$vm_name" 2>/dev/null | grep "State:" | awk '{print $2}')
    fi
    
    echo "$status"
}

# Get connection URI
get_connection_uri() {
    if virsh -c qemu:///system list --all --name 2>/dev/null | grep -v '^$' | grep -q .; then
        echo "qemu:///system"
    elif virsh -c qemu:///session list --all --name 2>/dev/null | grep -v '^$' | grep -q .; then
        echo "qemu:///session"
    else
        echo ""
    fi
}

status=$(get_vm_status "$vm_name")
conn_uri=$(get_connection_uri)

# Build virsh command
virsh_cmd="virsh"
if [ -n "$conn_uri" ]; then
    virsh_cmd="virsh -c $conn_uri"
fi

# Show actions based on status
if [[ "$status" == "running" ]]; then
    actions="󰍹 Connect
󰐥 Shutdown
󰜉 Reboot
󰤄 Suspend
󰈸 Force Off"
else
    actions="󰐊 Start"
    if [[ "$status" == "paused" ]]; then
        actions+="
󰤁 Resume"
    fi
fi

selected=$(echo -e "$actions" | rofi -dmenu \
    -p "VM: $vm_name" \
    -mesg "Status: $status" \
    -theme ~/.config/rofi/style.rasi \
    -show-icons)

if [ -z "$selected" ]; then
    exit 0
fi

# Execute action
case "$selected" in
    *"Connect"*)
        if command -v virt-viewer &> /dev/null; then
            if [ -n "$conn_uri" ]; then
                virt-viewer --connect "$conn_uri" "$vm_name" &
            else
                virt-viewer "$vm_name" &
            fi
        elif command -v virt-manager &> /dev/null; then
            if [ -n "$conn_uri" ]; then
                virt-manager --connect "$conn_uri" --show-domain-console "$vm_name" &
            else
                virt-manager --connect qemu:///system --show-domain-console "$vm_name" &
            fi
        else
            notify-send "VM Manager" "virt-viewer or virt-manager not found"
        fi
        ;;
    *"Start"*)
        $virsh_cmd start "$vm_name" 2>&1 | while read -r line; do
            notify-send "VM Manager" "$line"
        done
        ;;
    *"Shutdown"*)
        $virsh_cmd shutdown "$vm_name" 2>&1 | while read -r line; do
            notify-send "VM Manager" "$line"
        done
        ;;
    *"Reboot"*)
        $virsh_cmd reboot "$vm_name" 2>&1 | while read -r line; do
            notify-send "VM Manager" "$line"
        done
        ;;
    *"Suspend"*)
        $virsh_cmd suspend "$vm_name" 2>&1 | while read -r line; do
            notify-send "VM Manager" "$line"
        done
        ;;
    *"Resume"*)
        $virsh_cmd resume "$vm_name" 2>&1 | while read -r line; do
            notify-send "VM Manager" "$line"
        done
        ;;
    *"Force Off"*)
        confirm=$(echo -e "Yes\nNo" | rofi -dmenu \
            -p "Force off $vm_name?" \
            -mesg "This will forcefully power off the VM. Continue?" \
            -theme ~/.config/rofi/style.rasi)
        if [[ "$confirm" == "Yes" ]]; then
            $virsh_cmd destroy "$vm_name" 2>&1 | while read -r line; do
                notify-send "VM Manager" "$line"
            done
        fi
        ;;
esac


